<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDUSU Admin Panel</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
    h2 { text-align: center; color: #333; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, select, button { width: 100%; padding: 10px; margin-top: 5px; border-radius: 8px; border: 1px solid #ccc; }
    button { background: #007bff; color: white; font-weight: bold; cursor: pointer; }
    button:hover { background: #0056b3; }
    .progress { display: none; background: #ddd; border-radius: 10px; height: 8px; margin-top: 10px; overflow: hidden; }
    .progress i { display: block; height: 100%; width: 0%; background: #4caf50; transition: width 0.3s; }
    #adminMsg { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>ðŸ“˜ PDUSU Admin Panel</h2>

  <label>Course:</label>
  <select id="admCourse">
    <option>BCA</option>
    <option>B.Sc</option>
    <option>BA</option>
    <option>B.Com</option>
  </select>

  <label>Semester:</label>
  <select id="admSem">
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
    <option value="6">6</option>
  </select>

  <label>Subject Name:</label>
  <input type="text" id="admSubject" placeholder="Enter subject name">

  <label>YouTube Link (optional):</label>
  <input type="url" id="admYouTube" placeholder="Paste YouTube video URL">

  <label>Upload PDF (optional):</label>
  <input type="file" id="admPdfFile" accept="application/pdf">

  <button id="uploadBtn" onclick="handleUpload()">Upload & Save</button>

  <div class="progress"><i></i></div>
  <p id="adminMsg"></p>

  <hr>
  <h3>ðŸ“š Uploaded List</h3>
  <ul id="list"></ul>

  <script type="module">
    // âœ… Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";

    // âœ… Firebase Config (PDUSU project)
    const firebaseConfig = {
      apiKey: "AIzaSyBiRACgJgwPcn-6t2pFHpOMgYwYhu2eHgM",
      authDomain: "pdusu-edu.firebaseapp.com",
      projectId: "pdusu-edu",
      storageBucket: "pdusu-edu.appspot.com",
      messagingSenderId: "1049889029840",
      appId: "1:1049889029840:web:156d84270f60016174a8d5",
      measurementId: "G-KG0E4QNY9Z"
    };

    // âœ… Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const COLLECTION = "courses";

    // âœ… Generate random ID
    function uuid() {
      return "xxxxxx".replace(/x/g, () => Math.floor(Math.random() * 16).toString(16));
    }

    // âœ… Load existing data
    async function loadAll() {
      const list = document.getElementById('list');
      list.innerHTML = '<li>Loading...</li>';
      const q = query(collection(db, COLLECTION), orderBy("uploadedAt", "desc"));
      const snap = await getDocs(q);
      list.innerHTML = '';
      snap.forEach(doc => {
        const data = doc.data();
        const li = document.createElement('li');
        li.innerHTML = `
          <b>${data.subject}</b> (${data.course} - Sem ${data.semester})<br>
          ${data.youtube ? `<a href="${data.youtube}" target="_blank">ðŸŽ¥ YouTube</a>` : ''}
          ${data.pdfUrl ? ` | <a href="${data.pdfUrl}" target="_blank">ðŸ“„ PDF</a>` : ''}
        `;
        list.appendChild(li);
      });
    }

    // âœ… Upload Handler (PDF optional)
    async function handleUpload() {
      const course = document.getElementById('admCourse').value;
      const sem = Number(document.getElementById('admSem').value);
      const subject = document.getElementById('admSubject').value.trim();
      const youtube = document.getElementById('admYouTube').value.trim();
      const fileInput = document.getElementById('admPdfFile');
      const file = fileInput.files && fileInput.files[0];
      const adminMsg = document.getElementById('adminMsg');
      const progressBar = document.querySelector('.progress');
      const progressBarInner = progressBar.querySelector('i');

      adminMsg.textContent = '';

      if (!subject) {
        adminMsg.textContent = 'âš ï¸ à¤•à¥ƒà¤ªà¤¯à¤¾ subject name à¤­à¤°à¥‡à¤‚!';
        return;
      }

      // ðŸŸ¢ à¤…à¤—à¤° PDF à¤¨à¤¹à¥€à¤‚ à¤¹à¥ˆ â€” direct save
      if (!file) {
        try {
          await addDoc(collection(db, COLLECTION), {
            course,
            semester: sem,
            subject,
            youtube: youtube || '',
            pdfUrl: '',
            uploadedAt: serverTimestamp()
          });
          adminMsg.textContent = 'âœ… Entry saved without PDF!';
          document.getElementById('admSubject').value = '';
          document.getElementById('admYouTube').value = '';
          await loadAll();
        } catch (err) {
          adminMsg.textContent = 'âŒ Error: ' + err.message;
        }
        return;
      }

      // ðŸ”µ à¤…à¤—à¤° PDF à¤šà¥à¤¨à¥€ à¤—à¤ˆ à¤¹à¥ˆ â€” upload to Firebase Storage
      if (file.type !== 'application/pdf') {
        adminMsg.textContent = 'âš ï¸ à¤•à¥‡à¤µà¤² PDF file à¤…à¤ªà¤²à¥‹à¤¡ à¤•à¤°à¥‡à¤‚';
        return;
      }

      const path = `courses/${course.toLowerCase()}/sem${sem}/${uuid()}.pdf`;
      const sRef = storageRef(storage, path);
      const uploadTask = uploadBytesResumable(sRef, file);

      progressBar.style.display = 'block';
      progressBarInner.style.width = '0%';
      document.getElementById('uploadBtn').disabled = true;
      document.getElementById('uploadBtn').textContent = 'Uploading...';

      uploadTask.on(
        'state_changed',
        (snapshot) => {
          const percent = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
          progressBarInner.style.width = percent + '%';
        },
        (err) => {
          adminMsg.textContent = 'âŒ Upload failed: ' + err.message;
          progressBar.style.display = 'none';
          document.getElementById('uploadBtn').disabled = false;
          document.getElementById('uploadBtn').textContent = 'Upload & Save';
        },
        async () => {
          const downloadUrl = await getDownloadURL(uploadTask.snapshot.ref);
          await addDoc(collection(db, COLLECTION), {
            course,
            semester: sem,
            subject,
            youtube: youtube || '',
            pdfUrl: downloadUrl,
            uploadedAt: serverTimestamp()
          });
          adminMsg.textContent = 'âœ… Uploaded and saved successfully!';
          document.getElementById('admSubject').value = '';
          document.getElementById('admYouTube').value = '';
          document.getElementById('admPdfFile').value = '';
          progressBar.style.display = 'none';
          document.getElementById('uploadBtn').disabled = false;
          document.getElementById('uploadBtn').textContent = 'Upload & Save';
          await loadAll();
        }
      );
    }

    // ðŸ”ƒ Load list on start
    loadAll();
  </script>
</body>
</html>
